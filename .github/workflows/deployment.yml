name: Deployment
run-name: "Deployment #${{ github.run_number }}"

on:
  workflow_dispatch:

env:
  NAMESPACE: algorithms-catalogue

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: apex-algorithms-catalogue-web
    defaults:
      run:
        working-directory: ./deployment/algorithms-catalogue-web
    env:
      OS_ACCESS_KEY: ${{ secrets.OS_ACCESS_KEY }}
      OS_SECRET_KEY: ${{ secrets.OS_SECRET_KEY }}
      KUBECONFIG: kubeconfig.json
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: opentofu/setup-opentofu@v1
      - uses: azure/setup-helm@v4.2.0
        with:
          version: 'v3.16.0'
      - name: OpenTofu init & apply
        run: |
          tofu init
          tofu apply -auto-approve
      - name: Deploy
        run: helm upgrade algorithms-catalogue-web . --install --namespace="$NAMESPACE" --kube-insecure-skip-tls-verify